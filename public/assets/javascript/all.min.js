angular.module("btford.socket-io",[]).provider("socketFactory",function(){"use strict";var e="socket:";this.$get=["$rootScope","$timeout",function(t,r){var n=function(e,t){return t?function(){var n=arguments;r(function(){t.apply(e,n)},0)}:angular.noop};return function(r){r=r||{};var o=r.ioSocket||io.connect(),a=void 0===r.prefix?e:r.prefix,s=r.scope||t,u=function(e,t){o.on(e,t.__ng=n(o,t))},i=function(e,t){o.once(e,t.__ng=n(o,t))},l={on:u,addListener:u,once:i,emit:function(e,t,r){var a=arguments.length-1,r=arguments[a];return"function"==typeof r&&(r=n(o,r),arguments[a]=r),o.emit.apply(o,arguments)},removeListener:function(e,t){return t&&t.__ng&&(arguments[1]=t.__ng),o.removeListener.apply(o,arguments)},removeAllListeners:function(){return o.removeAllListeners.apply(o,arguments)},disconnect:function(e){return o.disconnect(e)},connect:function(){return o.connect()},forward:function(e,t){e instanceof Array==0&&(e=[e]),t||(t=s),e.forEach(function(e){var r=a+e,s=n(o,function(){Array.prototype.unshift.call(arguments,r),t.$broadcast.apply(t,arguments)});t.$on("$destroy",function(){o.removeListener(e,s)}),o.on(e,s)})}};return l}}]}),angular.module("horribleFilm",["ngRoute","flash","btford.socket-io"]),angular.module("horribleFilm").config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"app/components/page/home.html"}).when("/register",{templateUrl:"app/components/page/register.html",controller:"SessionCtrl",controllerAs:"register"}).when("/login",{templateUrl:"app/components/page/login.html",controller:"SessionCtrl",controllerAs:"session"}).when("/users",{templateUrl:"app/components/user/index.html",controller:"UserCtrl",controllerAs:"user"}).when("/users/:user_name",{templateUrl:"app/components/user/show.html",controller:"UserShowCtrl",controllerAs:"userShow"}).when("/users/:user_name/edit",{templateUrl:"app/components/user/edit.html",controller:"UserEditCtrl",controllerAs:"userEdit"}),t.html5Mode(!0)}]),angular.module("horribleFilm").controller("MainCtrl",["Auth","$rootScope","$location","$window",function(e,t,r,n){var o=this;o.loggedIn=e.isLoggedIn(),t.$on("$routeChangeStart",function(){o.loggedIn=e.isLoggedIn(),e.getUser().then(function(e){o.userName=e.data.userName},function(e){o.userName=void 0})}),o.logout=function(t){t.preventDefault(),e.logout(),r.path("/")}}]),angular.module("horribleFilm").factory("AuthToken",["$window",function(e){var t={};return t.getToken=function(){return e.localStorage.getItem("token")},t.setToken=function(t){t?e.localStorage.setItem("token",t):e.localStorage.removeItem("token")},t}]).factory("Auth",["$http","$q","AuthToken",function(e,t,r){var n={};return n.login=function(t,r){return e.post("/api/authenticate",{userName:t,password:r})},n.logout=function(){r.setToken()},n.isLoggedIn=function(){return r.getToken()?!0:!1},n.getUser=function(){return r.getToken()?e.get("/api/me"):t.reject({message:"Not logged in."})},n}]).factory("AuthInterceptor",["$q","$location","AuthToken","$window",function(e,t,r,n){var o={};return o.request=function(e){var n=r.getToken();if(n){e.headers["x-access-token"]=n;var o=t.path();("/register"===o||"/login"===o)&&t.path("/error")}return e},o.responseError=function(r){return n.localStorage.setItem("redirectPath",t.path()),403==r.status&&t.path("/login"),401==r.status&&t.path("/error"),e.reject(r)},o}]),angular.module("horribleFilm").service("socket",["socketFactory",function(e){return e()}]),angular.module("horribleFilm").factory("User",["$http",function(e){var t={};return t.all=function(){return e.get("/api/users/")},t.get=function(t){return e.get("/api/users/"+t)},t.create=function(t){return e.post("/api/users/",t)},t.updateProfile=function(t,r){return e.put("/api/users/"+t,r)},t}]),angular.module("horribleFilm").controller("SessionCtrl",["User","Auth","$location","$http","AuthToken","Flash","$window","socket",function(e,t,r,n,o,a,s,u){var i=this;i.newUser={},i.submitRegistration=function(){e.create(i.newUser).then(function(e){e.data.success!==!1?(u.emit("user:new",e.data),a.create("success","User has been successfully created! Login and edit your profile now!!!","custom-class"),r.path("/users/"+i.newUser.userName+"/edit/")):a.create("danger","One or more errors exist.","custom-class")})},i.login=function(){t.login(i.userName,i.password).then(function(e){if(1==e.data.success){a.create("success","You have been successfully logged in!","custom-class"),o.setToken(e.data.token);var t=s.localStorage.getItem("redirectPath");t?(s.localStorage.removeItem("redirectPath"),r.path(t)):r.path("/")}else a.create("danger","Wrong username/password combination.","custom-class")})}}]),angular.module("horribleFilm").controller("UserCtrl",["User","socket",function(e,t){function r(){e.all().then(function(e){n.users=e.data})}var n=this;r(),t.on("user:new",function(e){r()})}]),angular.module("horribleFilm").controller("UserEditCtrl",["$routeParams","User","$location",function(e,t,r){var n=this;t.get(e.user_name).then(function(e){n.profile=e.data.Profile}),n.updateProfile=function(){t.updateProfile(e.user_name,n.profile).then(function(t){r.path("/users/"+e.user_name)})}}]),angular.module("horribleFilm").controller("UserShowCtrl",["$routeParams","User",function(e,t){var r=this;t.get(e.user_name).then(function(e){r.user=e.data})}]),angular.module("horribleFilm").config(["$httpProvider",function(e){e.interceptors.push("AuthInterceptor")}]);