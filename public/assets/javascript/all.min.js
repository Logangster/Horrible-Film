angular.module("horribleFilm",["ngRoute","flash"]),angular.module("horribleFilm").config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"app/components/page/home.html"}).when("/register",{templateUrl:"app/components/page/register.html",controller:"SessionCtrl",controllerAs:"register"}).when("/login",{templateUrl:"app/components/page/login.html",controller:"SessionCtrl",controllerAs:"session"}).when("/users",{templateUrl:"app/components/user/index.html",controller:"UserCtrl",controllerAs:"user"}).when("/users/:user_name",{templateUrl:"app/components/user/show.html",controller:"UserShowCtrl",controllerAs:"userShow"}).when("/users/:user_name/edit",{templateUrl:"app/components/user/edit.html",controller:"UserEditCtrl",controllerAs:"userEdit"}),t.html5Mode(!0)}]),angular.module("horribleFilm").controller("MainCtrl",["Auth","$rootScope","$location","$window",function(e,t,r,o){var n=this;n.loggedIn=e.isLoggedIn(),t.$on("$routeChangeStart",function(){n.loggedIn=e.isLoggedIn(),e.getUser().then(function(e){n.userName=e.data.userName},function(e){n.userName=void 0})}),n.logout=function(t){t.preventDefault(),e.logout(),r.path("/")}}]),angular.module("horribleFilm").factory("AuthToken",["$window",function(e){var t={};return t.getToken=function(){return e.localStorage.getItem("token")},t.setToken=function(t){t?e.localStorage.setItem("token",t):e.localStorage.removeItem("token")},t}]).factory("Auth",["$http","$q","AuthToken",function(e,t,r){var o={};return o.login=function(t,r){return e.post("/api/authenticate",{userName:t,password:r})},o.logout=function(){r.setToken()},o.isLoggedIn=function(){return r.getToken()?!0:!1},o.getUser=function(){return r.getToken()?e.get("/api/me"):t.reject({message:"Not logged in."})},o}]).factory("AuthInterceptor",["$q","$location","AuthToken","$window",function(e,t,r,o){var n={};return n.request=function(e){var t=r.getToken();return t&&(e.headers["x-access-token"]=t),e},n.responseError=function(r){return o.localStorage.setItem("redirectPath",t.path()),403==r.status&&t.path("/login"),e.reject(r)},n}]),angular.module("horribleFilm").factory("User",["$http",function(e){var t={};return t.all=function(){return e.get("/api/users/")},t.get=function(t){return e.get("/api/users/"+t)},t.create=function(t){return e.post("/api/users/",t)},t.updateProfile=function(t,r){return e.put("/api/users/"+t,r)},t}]),angular.module("horribleFilm").controller("SessionCtrl",["User","Auth","$location","$http","AuthToken","Flash","$window",function(e,t,r,o,n,l,a){var s=this;s.newUser={},s.submitRegistration=function(){e.create(s.newUser).then(function(e){e.data.success!==!1&&(l.create("success","User has been successfully created! Login and edit your profile now!!!","custom-class"),r.path("/users/"+s.newUser.userName+"/edit/"))})},s.login=function(){t.login(s.userName,s.password).then(function(e){if(1==e.data.success){l.create("success","You have been successfully logged in!","custom-class"),n.setToken(e.data.token);var t=a.localStorage.getItem("redirectPath");t?(a.localStorage.removeItem("redirectPath"),r.path(t)):r.path("/")}else l.create("danger","Wrong username/password combination.","custom-class")})}}]),angular.module("horribleFilm").controller("UserCtrl",["User",function(e){function t(){e.all().then(function(e){r.users=e.data})}var r=this;t()}]),angular.module("horribleFilm").controller("UserEditCtrl",["$routeParams","User","$location",function(e,t,r){var o=this;t.get(e.user_name).then(function(e){o.profile=e.data.Profile}),o.updateProfile=function(){t.updateProfile(e.user_name,o.profile).then(function(t){r.path("/users/"+e.user_name)})}}]),angular.module("horribleFilm").controller("UserShowCtrl",["$routeParams","User",function(e,t){var r=this;t.get(e.user_name).then(function(e){r.user=e.data})}]),angular.module("horribleFilm").config(["$httpProvider",function(e){e.interceptors.push("AuthInterceptor")}]);