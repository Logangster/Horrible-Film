angular.module("btford.socket-io",[]).provider("socketFactory",function(){"use strict";var e="socket:";this.$get=["$rootScope","$timeout",function(t,n){var r=function(e,t){return t?function(){var r=arguments;n(function(){t.apply(e,r)},0)}:angular.noop};return function(n){n=n||{};var o=n.ioSocket||io.connect(),u=void 0===n.prefix?e:n.prefix,a=n.scope||t,s=function(e,t){o.on(e,t.__ng=r(o,t))},i=function(e,t){o.once(e,t.__ng=r(o,t))},l={on:s,addListener:s,once:i,emit:function(e,t,n){var u=arguments.length-1,n=arguments[u];return"function"==typeof n&&(n=r(o,n),arguments[u]=n),o.emit.apply(o,arguments)},removeListener:function(e,t){return t&&t.__ng&&(arguments[1]=t.__ng),o.removeListener.apply(o,arguments)},removeAllListeners:function(){return o.removeAllListeners.apply(o,arguments)},disconnect:function(e){return o.disconnect(e)},connect:function(){return o.connect()},forward:function(e,t){e instanceof Array==0&&(e=[e]),t||(t=a),e.forEach(function(e){var n=u+e,a=r(o,function(){Array.prototype.unshift.call(arguments,n),t.$broadcast.apply(t,arguments)});t.$on("$destroy",function(){o.removeListener(e,a)}),o.on(e,a)})}};return l}}]}),angular.module("horribleFilm",["ngRoute","flash","btford.socket-io"]),angular.module("horribleFilm").config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"app/components/page/home.html"}).when("/register",{templateUrl:"app/components/page/register.html",controller:"SessionCtrl",controllerAs:"register"}).when("/login",{templateUrl:"app/components/page/login.html",controller:"SessionCtrl",controllerAs:"session"}).when("/users",{templateUrl:"app/components/user/index.html",controller:"UserCtrl",controllerAs:"user"}).when("/users/:user_name",{templateUrl:"app/components/user/show.html",controller:"UserShowCtrl",controllerAs:"userShow"}).when("/users/:user_name/edit",{templateUrl:"app/components/user/edit.html",controller:"UserEditCtrl",controllerAs:"userEdit"}),t.html5Mode(!0)}]),angular.module("horribleFilm").controller("MainCtrl",["Auth","$rootScope","$location","$window",function(e,t,n,r){var o=this;o.loggedIn=e.isLoggedIn(),t.$on("$routeChangeStart",function(){o.loggedIn=e.isLoggedIn(),e.getUser().then(function(e){o.userName=e.data.userName},function(e){o.userName=void 0})}),o.logout=function(t){t.preventDefault(),e.logout(),n.path("/")}}]),angular.module("horribleFilm").factory("AuthToken",["$window",function(e){var t={};return t.getToken=function(){return e.localStorage.getItem("token")},t.setToken=function(t){t?e.localStorage.setItem("token",t):e.localStorage.removeItem("token")},t}]).factory("Auth",["$http","$q","AuthToken",function(e,t,n){var r={};return r.login=function(t,n){return e.post("/api/authenticate",{userName:t,password:n})},r.logout=function(){n.setToken()},r.isLoggedIn=function(){return n.getToken()?!0:!1},r.getUser=function(){return n.getToken()?e.get("/api/me"):t.reject({message:"Not logged in."})},r}]).factory("AuthInterceptor",["$q","$location","AuthToken","$window",function(e,t,n,r){var o={};return o.request=function(e){var t=n.getToken();return t&&(e.headers["x-access-token"]=t),e},o.responseError=function(n){return r.localStorage.setItem("redirectPath",t.path()),403==n.status&&t.path("/login"),e.reject(n)},o}]),angular.module("horribleFilm").service("socket",["socketFactory",function(e){return e()}]),angular.module("horribleFilm").factory("User",["$http",function(e){var t={};return t.all=function(){return e.get("/api/users/")},t.get=function(t){return e.get("/api/users/"+t)},t.create=function(t){return e.post("/api/users/",t)},t.updateProfile=function(t,n){return e.put("/api/users/"+t,n)},t}]),angular.module("horribleFilm").controller("SessionCtrl",["User","Auth","$location","$http","AuthToken","Flash","$window","socket",function(e,t,n,r,o,u,a,s){var i=this;i.newUser={},i.submitRegistration=function(){e.create(i.newUser).then(function(e){e.data.success!==!1&&(u.create("success","User has been successfully created! Login and edit your profile now!!!","custom-class"),n.path("/users/"+i.newUser.userName+"/edit/"))})},i.login=function(){t.login(i.userName,i.password).then(function(e){if(1==e.data.success){s.emit("user:new",e.data),u.create("success","You have been successfully logged in!","custom-class"),o.setToken(e.data.token);var t=a.localStorage.getItem("redirectPath");t?(a.localStorage.removeItem("redirectPath"),n.path(t)):n.path("/")}else u.create("danger","Wrong username/password combination.","custom-class")})}}]),angular.module("horribleFilm").controller("UserCtrl",["User","socket",function(e,t){function n(){e.all().then(function(e){r.users=e.data})}var r=this;n(),t.on("user:new",function(e){n()})}]),angular.module("horribleFilm").controller("UserEditCtrl",["$routeParams","User","$location",function(e,t,n){var r=this;t.get(e.user_name).then(function(e){r.profile=e.data.Profile}),r.updateProfile=function(){t.updateProfile(e.user_name,r.profile).then(function(t){n.path("/users/"+e.user_name)})}}]),angular.module("horribleFilm").controller("UserShowCtrl",["$routeParams","User",function(e,t){var n=this;t.get(e.user_name).then(function(e){n.user=e.data})}]),angular.module("horribleFilm").config(["$httpProvider",function(e){e.interceptors.push("AuthInterceptor")}]);